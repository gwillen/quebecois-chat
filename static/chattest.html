<html>

<head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript">
        parms = {};
        location.
            search.
            substr(1).
            split('&').
            map(function(x) {
                var parm = x.split('=');
                parms[decodeURIComponent(parm[0])] = decodeURIComponent(parm[1]);
            });
        document.write('<script type="text/javascript" src="chatdebug.js"><' + '/script>');
        document.write('<script type="text/javascript" src="chattest.js?v=' + parms['v'] + '""><' + '/script>');

        function send_message() {
            var msg_box = $('#message_out');
            var username = username_box.val();
            var message = msg_box.val();
            QUEBECOIS.send(current_channel, username, message, true);
            msg_box.val('');
        }
    </script>
</head>

<body style='margin: 0px'>
    <form action='#' onsubmit='send_message(); return false;' style='margin-bottom: 0px' name='message_form'>
        <table id="chatmain" style='border-collapse: collapse' width='100%'><tr>
            <td style='padding: 0px; vertical-align: top'><div id='messages' style='width: 100%; overflow: auto'></div></td>
            <td style="padding: 0px; width:200px; vertical-align:top"><div id='userlist' style='width: 100%; overflow: auto'></div></td>
        </tr></table>

        <table style='border-collapse: collapse' id="chatextras" width='100%'><tr>
            <td style="white-space: nowrap;">
                <input type='text' name='username' id='username' placeholder='username'>
                <select disabled name='channel_list' id='channel_list'>
                    <option value="x" selected="selected">Loading...</option>
                </select>
            </td>
            <td width='99%'>
                <input type='text' name='message_out' id='message_out' placeholder='message' style='width: 100%'>
            </td>
            <td id='freshness' style="white-space: nowrap;">
                Lag: NaN
            </td>
            <td style="white-space: nowrap;">
                <input type='submit' name='submit' value='Send'>
                <input type='checkbox' name='fixed' id='fixed_checkbox'>
                <label for='fixed_checkbox'>Fixed chatpane</label>
                <input type='checkbox' name='hide' id='hide_checkbox'>
                <label for='hide_checkbox'>Hide chat</label>
            </td>
        </tr></table>
    </form>
    <script type="text/javascript">
        var MAX_QUEUE_LATENCY = 60;  // Oldest message we can see, in seconds, before we give up and restart

        var now = function() {
            return Date.now() / 1000;
        };

        var formatTime = function(unixTimestamp) {
            var dt = new Date(unixTimestamp * 1000);

            var hours = dt.getHours();
            var minutes = dt.getMinutes();
            var seconds = dt.getSeconds();

            if (hours < 10)
                hours = '0' + hours;

            if (minutes < 10)
                minutes = '0' + minutes;

            if (seconds < 10)
                seconds = '0' + seconds;

            return hours + ":" + minutes + ":" + seconds;
        }

        var username_box = $('#username');
        if (parms['user']) {
            username_box.val(parms['user']);
        }
        if (parms['channel']) {
            current_channel = parms['channel'];
        } else {
            current_channel = 'general_chat';
        }

        $('#channel_list').change(function(e) {
            console.log("value is: ", e.target.value);
            current_channel = e.target.value;
            start_your_engines();
        });

        QUEBECOIS.get_channels(function(channels) {
            if (channels.indexOf(current_channel) == -1) {
                channels.push(current_channel);
            }
            var channel_list = $('#channel_list');
            if (channels && channels.length > 0) {
                channel_list.children(0).remove();
                channels.map(function(ch) {
                    channel_list.append($('<option>' + ch + '</option>'));
                });
                channel_list.val(current_channel);
                channel_list.prop("disabled", false);
            } else {
                console.log("FUCK XXX"); // XXX
            }
        });

        // XXX: slightly ugh.
        $('#messages').css({'height': '' + ($('body').height() - $('table#chatextras').height()) + 'px'});
        $('#userlist').css({'height': '' + ($('body').height() - $('table#chatextras').height()) + 'px'});

        $('#fixed_checkbox').click(function() {
            QUEBECOIS.fixed_chatpane($('#fixed_checkbox')[0].checked);
        });

        $('#hide_checkbox').click(function() {
            QUEBECOIS.hide_chatpane($('#hide_checkbox')[0].checked);
        });

        QUEBECOIS.xhr_state_length = -1;
        var update_lag_meter = function() {
            var now = (new Date().getTime())/1000;
            if (QUEBECOIS.xhr && QUEBECOIS.xhr.responseText && QUEBECOIS.xhr.responseText.length != QUEBECOIS.xhr_state_length) {
                QUEBECOIS.xhr_state_length = QUEBECOIS.xhr.responseText.length;
                QUEBECOIS.last_poll_time = now;
            }
            var lag = now - QUEBECOIS.last_poll_time;
            $('#freshness').text("Lag: " + Math.round(lag) + " s");
            setTimeout(update_lag_meter, 1000);
        }
        update_lag_meter();

        var update_userlist = function(presences) {
            var userlist = $('#userlist');
            userlist.text('');
            $.each(Object.keys(presences).sort(), function(idx, k) {
                var presence = presences[k];
                var age = now() - presence.timestamp;
                var text = '';
                text += "[" + presence.presence_token + "] ";
                text += presence.sender + " ";
                text += age.toFixed(1);
                var user_div = $('<div>');
                user_div.text(text);
                userlist.append(user_div);
            });
        }

        var presences = {};
        var update_userlist_periodically = function() {
            update_userlist(presences);
            setTimeout(update_userlist_periodically, 1000);
        };
        update_userlist_periodically();

        var start_your_engines = function() {
            var messages_div = $('#messages');
            if (window.chat_connection) {
                window.chat_connection.close_connection();
            }
            window.chat_connection = new QUEBECOIS.ChatConnection([current_channel], username_box.val(), function(e) {
                console.log("GOT EVENT", e);
                if (e.type == "message") {
                    var sender = e.message.from.user;
                    var content = e.message.content;
                    var message = '';
                    message += formatTime(e.message.timestamp) + " ";
                    message += '<' + sender + '> ' + content;

                    var msg_div = $('<div>');
                    if (e.historical) {
                        msg_div.css({"background-color": "lightgrey"});
                    }
                    var at_bottom = messages_div[0].scrollHeight - messages_div.scrollTop() == messages_div.outerHeight()
                    msg_div.text(message);
                    messages_div.append(msg_div);
                    if (at_bottom) {
                        messages_div.scrollTop(messages_div[0].scrollHeight);
                    }
                } else if (e.type == "presence") {
                    var presence = e.presence;
                    var sender = presence.sender;
                    var age = now() - presence.timestamp;
                    if (age > MAX_QUEUE_LATENCY) {
                        // We're getting messages way after they're sent -- our queue is full of stale stuff. To avoid getting further and further behind, dump it.
                        console.log("QUEUE LATENCY TOO HIGH (", age, "), bailing out");
                        start_your_engines();
                    }
                    console.log("PRESENCE: ", sender, age, presence);
                    presences[presence.presence_token] = presence;
                    update_userlist(presences);
                } else {
                    console.log("GOT UNKNOWN EVENT", e);
                }
            }, function() {
                // If something goes really wrong, clear it all so we can start over.
                messages_div.text('');
                presences = {};
                update_userlist(presences);
            });
            console.log("HTML Created new chatconnection with uid ", window.chat_connection.uniqueId());
        };

        start_your_engines();

        var conn = window.chat_connection;

        function vis_change() {
            var vis = document.webkitVisibilityState;
            console.log("VIS: ", vis);
            if (vis == "visible") {
                // At least in chrome, this always fires before the focus event, so we'll end up in the right state.
                conn.set_presence_state(QUEBECOIS.PresenceStateEnum.VISIBLE);
            } else {
                conn.set_presence_state(QUEBECOIS.PresenceStateEnum.HIDDEN);
            }
        }
        document.addEventListener("webkitvisibilitychange", vis_change, false);

        $(window.top).blur(function() {
            console.log("BLUR");
            // At least in chrome, this always fires before the VIS:hidden event, so we'll end up in the right state.
            conn.set_presence_state(QUEBECOIS.PresenceStateEnum.VISIBLE);
        });

        $(window.top).focus(function() {
            console.log("FOCUS");
            conn.set_presence_state(QUEBECOIS.PresenceStateEnum.FOCUSED);
            conn.reset_active_timer();
        });

        var ping = function() { conn.reset_active_timer(); };

        $(window.top).mousemove(ping);
        $(window.top).keypress(ping);
        $(window.top).keydown(ping);
        $(window.top).keyup(ping);

        // Technically it's most correct to do this _after_ we install the handlers, although in JS there's probably no race anyway.
        if (window.top.document.hasFocus()) {
            window.chat_connection.set_presence_state(QUEBECOIS.PresenceStateEnum.FOCUSED);
            window.chat_connection.reset_active_timer();
            console.log("document has focus");
        } else if (document.webkitVisibilityState) {
            window.chat_connection.set_presence_state(QUEBECOIS.PresenceStateEnum.VISIBLE);
        } else {
            window.chat_connection.set_presence_state(QUEBECOIS.PresenceStateEnum.HIDDEN);
        }
    </script>
</body>

</html>
