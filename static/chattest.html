<html>

<head>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript">
        parms = {};
        location.
            search.
            substr(1).
            split('&').
            map(function(x) {
                var parm = x.split('=');
                parms[parm[0]] = parm[1];
            });
        document.write('<script type="text/javascript" src="chatdebug.js"><' + '/script>');
        document.write('<script type="text/javascript" src="chattest.js?v=' + parms['v'] + '""><' + '/script>');

        function send_message() {
            var msg_box = $('#message_out');
            var username = username_box.val();
            var message = msg_box.val();
            QUEBECOIS.send(current_channel, username, message, true);
            msg_box.val('');
        }
    </script>
</head>

<body style='margin: 0px'>
    <form action='#' onsubmit='send_message(); return false;' style='margin-bottom: 0px'>
        <div id='messages' style='width: 100%; overflow: auto'></div>
        <table width='100%'><tr>
            <td style="white-space: nowrap;">
                <input type='text' name='username' id='username' placeholder='username'>
                <input type='text' name='channel' id='channel' placeholder='channel'>
            </td>
            <td width='99%'>
                <input type='text' name='message_out' id='message_out' placeholder='message' style='width: 100%'>
            </td>
            <td id='freshness' style="white-space: nowrap;">
                Lag: NaN
            </td>
            <td style="white-space: nowrap;">
                <input type='submit' name='submit' value='Send'>
                <input type='checkbox' name='fixed' id='fixed_checkbox'>
                <label for='fixed_checkbox'>Fixed chatpane</label>
                <input type='checkbox' name='hide' id='hide_checkbox'>
                <label for='hide_checkbox'>Hide chat</label>
            </td>
        </tr></table>
    </form>
    <script type="text/javascript">
        var formatTime = function(unixTimestamp) {
            var dt = new Date(unixTimestamp * 1000);

            var hours = dt.getHours();
            var minutes = dt.getMinutes();
            var seconds = dt.getSeconds();

            if (hours < 10)
                hours = '0' + hours;

            if (minutes < 10)
                minutes = '0' + minutes;

            if (seconds < 10)
                seconds = '0' + seconds;

            return hours + ":" + minutes + ":" + seconds;
        }

        var username_box = $('#username');
        if (parms['user']) {
            username_box.val(parms['user']);
        }
        var channel_box = $('#channel');
        if (parms['channel']) {
            channel_box.val(parms['channel']);
        } else {
            channel_box.val('wikichat');
        }

        if (parms['page']) {
            current_page = parms['page'];
        }

        current_channel = channel_box.val();

        // XXX: slightly ugh.
        $('#messages').css({'height': '' + ($('body').height() - $('table').height()) + 'px'});

        $('#fixed_checkbox').click(function() {
            QUEBECOIS.fixed_chatpane($('#fixed_checkbox')[0].checked);
        });

        $('#hide_checkbox').click(function() {
            QUEBECOIS.hide_chatpane($('#hide_checkbox')[0].checked);
        });

        QUEBECOIS.xhr_state_length = -1;
        var update_lag_meter = function() {
            var now = (new Date().getTime())/1000;
            if (QUEBECOIS.xhr && QUEBECOIS.xhr.responseText && QUEBECOIS.xhr.responseText.length != QUEBECOIS.xhr_state_length) {
                QUEBECOIS.xhr_state_length = QUEBECOIS.xhr.responseText.length;
                QUEBECOIS.last_poll_time = now;
            }
            var lag = now - QUEBECOIS.last_poll_time;
            $('#freshness').text("Lag: " + Math.round(lag) + " s");
            setTimeout(update_lag_meter, 1000);
        }
        update_lag_meter();

        var messages_div = $('#messages');
        QUEBECOIS.go(current_channel, function(e, old) {
            //XXX console.log("GOT EVENT", e);
            var sender = e.message.from.user;
            var content = e.message.content;
            var message = '';
            message += formatTime(e.message.timestamp) + " ";
            message += '<' + sender + '> ' + content;

            var msg_div = $('<div>');
            if (old) {
                msg_div.css({"background-color": "lightgrey"});
            }
            var at_bottom = messages_div[0].scrollHeight - messages_div.scrollTop() == messages_div.outerHeight()
            msg_div.text(message);
            messages_div.append(msg_div);
            if (at_bottom) {
                messages_div.scrollTop(messages_div[0].scrollHeight);
            }
        }, function() {
            // If something goes really wrong, clear it all so we can start over.
            messages_div.text('');
        });
    </script>
</body>

</html>
